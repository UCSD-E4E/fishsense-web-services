# Prefer Traefik's forwarded proto if present (TLS terminates there)
map $http_x_forwarded_proto $forwarded_proto {
    default $http_x_forwarded_proto;
    ''      $scheme;
}

server {
    # If Traefik speaks plain HTTP to NGINX, this is fine.
    listen 80 http2;
    # Use your public host so Set-Cookie/redirects line up
    server_name orchestrator.fishsense.e4e.ucsd.edu;

    # ---------- PUBLIC: Authentik outpost plumbing ----------
    # MUST be reachable without auth
    location /outpost.goauthentik.io {
        proxy_set_header Host orchestrator.fishsense.e4e.ucsd.edu;
        proxy_pass              http://authentik_server:9000/outpost.goauthentik.io;

        proxy_pass_request_body off;
        proxy_set_header        Content-Length "";

        # Forward caller creds if present (for Basic pass-through)
        proxy_set_header Authorization $http_authorization;

        # Forward exact context as Traefik saw it
        proxy_set_header X-Original-URI    $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Forwarded-Proto $forwarded_proto;
        proxy_set_header X-Forwarded-For   $remote_addr;
        proxy_set_header X-Real-IP         $remote_addr;
    }

    # ---------- INTERNAL: subrequest used by auth_request ----------
    location = /_authentik_auth {
        internal;

        proxy_set_header Host orchestrator.fishsense.e4e.ucsd.edu;
        proxy_pass http://authentik_server:9000/outpost.goauthentik.io/auth/nginx;

        proxy_pass_request_body off;
        proxy_set_header Content-Length "";

        # forward caller creds + context (critical)
        proxy_set_header Authorization      $http_authorization;
        proxy_set_header X-Original-URI     $request_uri;
        proxy_set_header X-Original-Method  $request_method;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Proto  $forwarded_proto;
        proxy_set_header X-Forwarded-For    $remote_addr;
        proxy_set_header X-Real-IP          $remote_addr;
    }


    # Basic challenge (if using Basic via Proxy Provider)
    location @api_auth_401 {
        add_header WWW-Authenticate 'Basic realm="FishSense Proxy"' always;
        return 401;
    }

    # ---------- Example: protected upstream ----------
    location / {
        proxy_pass http://fishsense-api:8000;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $forwarded_proto;

        proxy_set_header Upgrade   $http_upgrade;
        proxy_set_header Connection $connection_upgrade_keepalive;

        # Gate every request via Authentik
        auth_request     /_authentik_auth;

        # For Basic:
        error_page 401 = @api_auth_401;

        # propagate Set-Cookie from outpost to client
        auth_request_set $auth_cookie $upstream_http_set_cookie;
        add_header       Set-Cookie $auth_cookie always;

        # Translate the outpost identity headers to the app
        auth_request_set $authentik_username     $upstream_http_x_authentik_username;
        auth_request_set $authentik_groups       $upstream_http_x_authentik_groups;
        auth_request_set $authentik_entitlements $upstream_http_x_authentik_entitlements;
        auth_request_set $authentik_email        $upstream_http_x_authentik_email;
        auth_request_set $authentik_name         $upstream_http_x_authentik_name;
        auth_request_set $authentik_uid          $upstream_http_x_authentik_uid;

        proxy_set_header X-authentik-username     $authentik_username;
        proxy_set_header X-authentik-groups       $authentik_groups;
        proxy_set_header X-authentik-entitlements $authentik_entitlements;
        proxy_set_header X-authentik-email        $authentik_email;
        proxy_set_header X-authentik-name         $authentik_name;
        proxy_set_header X-authentik-uid          $authentik_uid;

        # If using "Send HTTP Basic authentication" in the provider:
        auth_request_set $authentik_auth $upstream_http_authorization;
        proxy_set_header Authorization $authentik_auth;
    }

    # If you want file serving via alias, use trailing slash patterns to avoid subtle path issues:
    # location /api/v1/data/raw/ { alias /data/raw/; ... same auth_request block as above ... }
}