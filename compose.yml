services:
  label_studio_reporter:
    image: ghcr.io/ucsd-e4e/label-studio-slack-reporter:v1.0.9
    container_name: label_studio_reporter
    restart: always
    command: --config /e4e/config/config.toml
    ports:
      - 9101:9100
    networks:
      - caddy_proxy
      - default
    volumes:
      - ./label_studio_reporter/config:/e4e/config/:ro
      - ./label_studio_reporter/cache:/e4e/cache/:rw
      - ./label_studio_reporter/logs:/e4e/logs/:rw
    user: "${USER_ID}:${GROUP_ID}"

  proxy:
    image: nginx:1.29.1-alpine
    container_name: fishsense_proxy
    labels:
      caddy: orchestrator.fishsense.e4e.ucsd.edu
      caddy.reverse_proxy: "{{upstreams 80}}"
    volumes:
      - ./proxy/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./proxy_volumes/data:/api/v1/data
    networks:
      - caddy_proxy
      - default
    restart: on-failure:15

  temporal:
    container_name: fishsense-temporal
    depends_on:
      - postgres
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - DBNAME=temporal_db
      - POSTGRES_USER=temporal
      - POSTGRES_SEEDS=postgres
      - SKIP_DB_CREATE=true
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CLI_ADDRESS=temporal:7233
    image: temporalio/auto-setup:1.28.1.0
    env_file:
      - .secrets/temporal_database_password.env
    ports:
      - 7233:7233
    volumes:
      - ./temporal_volumes/dynamicconfig:/etc/temporal/config/dynamicconfig
    restart: on-failure:15

  temporal-ui:
    container_name: fishsense_temporal-ui
    depends_on:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=fishsense-temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
      - TEMPORAL_UI_PUBLIC_PATH=/temporal
      - TEMPORAL_AUTH_ENABLED=true
      - TEMPORAL_AUTH_PROVIDER_URL=https://auth.fabricant.ucsd.edu/application/o/fishsense-temporal/
      - TEMPORAL_AUTH_CALLBACK_URL=https://orchestrator.fishsense.e4e.ucsd.edu/temporal/auth/sso/callback
      - TEMPORAL_AUTH_SCOPES=openid,email,profile
    env_file:
      - .secrets/temporal_ui.env
    image: temporalio/ui:2.39.0
    restart: on-failure:15

  temporal-worker:
    depends_on:
      - temporal
    volumes:
      - ./worker_volumes/config:/e4efs/config:ro
      - ./worker_volumes/logs:/e4efs/logs:rw
    image: ghcr.io/ucsd-e4e/fishsense-api-workflow-worker:v1.3.1
    restart: on-failure:15
    deploy:
      replicas: 2

  # spider:
  #   image: ghcr.io/ucsd-e4e/fishsense-data-processing-spider:v1.2.3
  #   container_name: fishsense_data_processing_spider
  #   volumes:
  #     - fishsense_data_reef:/mnt/fishsense_data_reef:ro
  #     - ./spider_volumes/config/settings.toml:/e4efs/config/settings.toml:ro
  #     - ./spider_volumes/config/.secrets.toml:/e4efs/config/.secrets.toml:ro
  #     - ./spider_volumes/config/data_paths.json:/e4efs/config/data_paths.json:ro
  #     - ./spider_volumes/data:/e4efs/data:rw
  #     - ./spider_volumes/logs:/e4efs/logs:rw
  #     - ./spider_volumes/cache:/e4efs/cache:rw
  #     - fishsense_lens_cal:/mnt/fishsense_lens_cal:ro
  #     - fishsense_process_work:/mnt/fishsense_process_work:rw
  #   environment:
  #     E4EFS_POSTGRES__USERNAME: postgres
  #     E4EFS_POSTGRES__HOST: postgres
  #     E4EFS_POSTGRES__PASSWORD_FILE: /run/secrets/postgres_admin_password
  #     E4EFS_SCRAPER__DATA_PATHS: /e4efs/config/data_paths.json
  #     E4EFS_WEB_API__ROOT_URL: https://orchestrator.fishsense.e4e.ucsd.edu
  #   ports:
  #     - 9095:9090
  #   secrets:
  #     - postgres_admin_password
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 4G
  postgres:
    image: postgres:16.4
    restart: always
    shm_size: 128 mb
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_admin_password
    volumes:
      - ./pg_volumes/data/:/var/lib/postgresql/data/:rw
      - ./pg_volumes/config/:/etc/postgresql/:ro
      # - ./.secrets/certs/:/certs/:ro
      - ./pg_volumes/scripts/:/docker-entrypoint-initdb.d/:ro
      - /etc/passwd:/etc/passwd:ro
    secrets:
      - postgres_admin_password
    command: --config_file=/etc/postgresql/postgres.conf
    ports:
      - 5432:5432
    user: "${USER_ID}:${GROUP_ID}"

secrets:
  postgres_admin_password: 
    file: .secrets/postgres_admin_password.txt

volumes:
  fishsense_data_reef:
    external: true
  fishsense_lens_cal:
    external: true
  fishsense_process_work:
    external: true

networks:
  caddy_proxy:
    external: true
